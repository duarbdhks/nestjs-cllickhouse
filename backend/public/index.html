<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 주문 - E-Commerce Shop</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard Variable', 'Pretendard', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <!-- Header Navigation -->
    <header class="sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary-500">
                        <i data-lucide="shopping-bag" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white">E-Commerce Shop</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">상품 주문 시스템</p>
                    </div>
                </div>

                <nav class="flex items-center gap-4">
                    <a href="/" class="flex items-center gap-2 rounded-lg bg-primary-50 dark:bg-primary-900/20 px-4 py-2 text-sm font-medium text-primary-700 dark:text-primary-400">
                        <i data-lucide="shopping-cart" class="h-4 w-4"></i>
                        <span class="hidden sm:inline">상품</span>
                    </a>
                    <a href="/dashboard.html" class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="bar-chart-3" class="h-4 w-4"></i>
                        <span class="hidden sm:inline">대시보드</span>
                    </a>
                    <button id="darkModeToggle" class="inline-flex h-10 w-10 items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="moon" class="h-5 w-5"></i>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Product Catalog Section -->
            <div class="lg:col-span-2 space-y-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">상품 목록</h2>
                    <p class="text-gray-600 dark:text-gray-400">원하는 상품을 선택하고 장바구니에 담아주세요</p>
                </div>

                <!-- Product Grid -->
                <div id="productCatalog" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Cart & Order Section -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Shopping Cart -->
                <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                    <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary-100 dark:bg-primary-900/20">
                                    <i data-lucide="shopping-cart" class="h-5 w-5 text-primary-600 dark:text-primary-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">장바구니</h3>
                            </div>
                            <span id="cartCount" class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-500 text-xs font-bold text-white">0</span>
                        </div>
                    </div>

                    <div class="p-6">
                        <div id="cartItems" class="space-y-3 mb-6">
                            <!-- Empty State -->
                            <div id="emptyCart" class="text-center py-8">
                                <i data-lucide="shopping-basket" class="h-12 w-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"></i>
                                <p class="text-sm text-gray-500 dark:text-gray-400">장바구니가 비어있습니다</p>
                            </div>
                        </div>

                        <!-- Total Section -->
                        <div id="totalSection" class="hidden space-y-3">
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between text-gray-600 dark:text-gray-400">
                                    <span>상품 금액</span>
                                    <span id="subtotal" class="font-medium">₩0</span>
                                </div>
                                <div class="flex justify-between text-gray-600 dark:text-gray-400">
                                    <span>배송비</span>
                                    <span id="shipping" class="font-medium">₩3,000</span>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-base font-semibold text-gray-900 dark:text-white">총 금액</span>
                                    <span id="totalAmount" class="text-xl font-bold text-primary-600 dark:text-primary-400">₩0</span>
                                </div>
                            </div>
                        </div>

                        <button id="checkoutBtn" disabled class="w-full mt-6 inline-flex items-center justify-center gap-2 rounded-lg bg-primary-600 px-4 py-3 text-sm font-semibold text-white hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="credit-card" class="h-4 w-4"></i>
                            <span>주문하기</span>
                        </button>
                    </div>
                </div>

                <!-- User Selection -->
                <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/20">
                            <i data-lucide="user" class="h-5 w-5 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">주문 정보</h3>
                    </div>
                    <div class="relative">
                        <select id="userId" class="w-full appearance-none rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2.5 pr-10 text-sm text-gray-900 dark:text-white focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20">
                            <option value="" disabled selected>사용자 선택</option>
                            <!-- Users loaded dynamically from API -->
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Quick Test -->
                <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-orange-100 dark:bg-orange-900/20">
                            <i data-lucide="zap" class="h-5 w-5 text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">테스트 주문</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">파이프라인 테스트용</p>
                        </div>
                    </div>
                    <button id="quickTestBtn" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-orange-500 px-4 py-3 text-sm font-semibold text-white hover:bg-orange-600 transition-colors">
                        <i data-lucide="zap" class="h-4 w-4"></i>
                        <span>10개 주문 생성</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="w-full max-w-md rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-8 shadow-2xl">
            <div class="text-center">
                <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/20">
                    <i data-lucide="check-circle" class="h-10 w-10 text-green-600 dark:text-green-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">주문 완료!</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-1">주문 번호</p>
                <p id="orderNumber" class="text-lg font-bold text-primary-600 dark:text-primary-400 mb-4"></p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">주문하신 상품은 빠르게 배송될 예정입니다</p>
                <button id="closeModalBtn" class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-6 py-2.5 text-sm font-semibold text-white hover:bg-primary-700 transition-colors">
                    확인
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="flex items-center gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3 shadow-lg">
            <div class="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/20">
                <i data-lucide="check" class="h-4 w-4 text-green-600 dark:text-green-400"></i>
            </div>
            <span id="toastMessage" class="text-sm font-medium text-gray-900 dark:text-white"></span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle?.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            lucide.createIcons();
        });

        // Product catalog (loaded from API)
        let products = [];
        let cart = [];

        // Icon mapping for products based on name/category
        function getProductIcon(product) {
            const name = product.name.toLowerCase();
            const category = (product.category || '').toLowerCase();

            if (name.includes('laptop') || name.includes('노트북')) return 'laptop';
            if (name.includes('mouse') || name.includes('마우스')) return 'mouse';
            if (name.includes('keyboard') || name.includes('키보드')) return 'keyboard';
            if (name.includes('monitor') || name.includes('모니터')) return 'monitor';
            if (name.includes('headphone') || name.includes('헤드셋') || name.includes('헤드폰')) return 'headphones';
            if (name.includes('coffee') || name.includes('커피')) return 'coffee';
            if (name.includes('shoe') || name.includes('신발')) return 'footprints';
            if (name.includes('backpack') || name.includes('가방')) return 'backpack';
            if (name.includes('lamp') || name.includes('램프')) return 'lamp';
            if (name.includes('usb') || name.includes('hub')) return 'usb';

            // Category-based fallback
            if (category.includes('electronics') || category.includes('전자제품')) return 'monitor';
            if (category.includes('accessories') || category.includes('악세서리')) return 'package';
            if (category.includes('audio') || category.includes('오디오')) return 'headphones';

            return 'box'; // default icon
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Load data from API
            await Promise.all([loadProducts(), loadUsers()]);

            // Event listeners
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
            document.getElementById('quickTestBtn').addEventListener('click', quickTest);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);

            // Initialize icons
            lucide.createIcons();
        });

        // Load products from API
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) {
                    throw new Error(`Failed to load products: ${response.statusText}`);
                }

                products = await response.json();

                const catalog = document.getElementById('productCatalog');
                catalog.innerHTML = products.map(product => {
                    const icon = getProductIcon(product);
                    return `
                        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                            <div class="h-40 bg-gradient-to-br from-primary-100 to-primary-200 dark:from-primary-900/20 dark:to-primary-800/20 flex items-center justify-center overflow-hidden">
                                ${product.imageUrl
                                    ? `<img src="${product.imageUrl}" alt="${product.name}" class="w-full h-full object-cover" />`
                                    : `<i data-lucide="${icon}" class="h-16 w-16 text-primary-600 dark:text-primary-400"></i>`
                                }
                            </div>
                            <div class="p-4">
                                <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1">${product.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">${product.category || '일반'}</p>
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-xl font-bold text-gray-900 dark:text-white">₩${Number(product.price).toLocaleString()}</span>
                                </div>
                                <button onclick="addToCart('${product.id}'); return false;" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-primary-700 active:bg-primary-800 transition-colors cursor-pointer">
                                    <i data-lucide="shopping-cart" class="h-4 w-4"></i>
                                    <span>담기</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load products:', error);
                showToast('상품 로드 실패: ' + error.message);
            }
        }

        // Load users from API
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error(`Failed to load users: ${response.statusText}`);
                }

                const users = await response.json();
                const userSelect = document.getElementById('userId');

                // Keep the default option, add users dynamically
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.email})`;
                    userSelect.appendChild(option);
                });

                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load users:', error);
                showToast('사용자 로드 실패: ' + error.message);
            }
        }

        // Add to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }

            const existingItem = cart.find(item => item.productId === productId);

            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }

            updateCart();
            showToast(`${product.name} 장바구니에 추가됨`);
        }

        // Update cart
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const totalSection = document.getElementById('totalSection');

            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div id="emptyCart" class="text-center py-8">
                        <i data-lucide="shopping-basket" class="h-12 w-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"></i>
                        <p class="text-sm text-gray-500 dark:text-gray-400">장바구니가 비어있습니다</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
                totalSection.classList.add('hidden');
                cartCount.textContent = '0';
                // Only update icons in cart area
                setTimeout(() => lucide.createIcons({ nameAttr: 'data-lucide' }), 0);
                return;
            }

            cartItems.innerHTML = cart.map((item, index) => `
                <div class="flex items-center justify-between gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 p-3">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">${item.name}</h4>
                        <p class="text-sm font-semibold text-primary-600 dark:text-primary-400 mt-0.5">₩${(item.price * item.quantity).toLocaleString()}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="decreaseQuantity(${index}); return false;" class="inline-flex h-7 w-7 items-center justify-center rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 dark:active:bg-gray-500 cursor-pointer">
                            <i data-lucide="minus" class="h-3 w-3"></i>
                        </button>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white min-w-[24px] text-center">${item.quantity}</span>
                        <button onclick="increaseQuantity(${index}); return false;" class="inline-flex h-7 w-7 items-center justify-center rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 dark:active:bg-gray-500 cursor-pointer">
                            <i data-lucide="plus" class="h-3 w-3"></i>
                        </button>
                        <button onclick="removeFromCart(${index}); return false;" class="inline-flex h-7 w-7 items-center justify-center rounded bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/30 active:bg-red-300 dark:active:bg-red-900/40 cursor-pointer">
                            <i data-lucide="x" class="h-3 w-3"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal >= 50000 ? 0 : 3000;
            const total = subtotal + shipping;

            document.getElementById('subtotal').textContent = `₩${subtotal.toLocaleString()}`;
            document.getElementById('shipping').textContent = shipping === 0 ? '무료' : `₩${shipping.toLocaleString()}`;
            document.getElementById('totalAmount').textContent = `₩${total.toLocaleString()}`;

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            checkoutBtn.disabled = false;
            totalSection.classList.remove('hidden');

            // Only update icons in cart area with setTimeout to avoid blocking
            setTimeout(() => lucide.createIcons({ nameAttr: 'data-lucide' }), 0);
        }

        function increaseQuantity(index) {
            cart[index].quantity++;
            updateCart();
        }

        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                updateCart();
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
            showToast('상품이 제거되었습니다');
        }

        // Checkout
        async function checkout() {
            const userId = document.getElementById('userId').value;

            if (!userId) {
                showToast('주문자를 선택해주세요');
                return;
            }

            if (cart.length === 0) {
                showToast('장바구니가 비어있습니다');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal >= 50000 ? 0 : 3000;
            const totalAmount = subtotal + shipping;

            const orderData = {
                userId: userId,
                totalAmount: totalAmount,
                status: 'completed',
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('orderNumber').textContent = result.orderId;
                    document.getElementById('successModal').classList.remove('hidden');
                    document.getElementById('successModal').classList.add('flex');

                    cart = [];
                    updateCart();
                    document.getElementById('userId').value = '';
                    lucide.createIcons();
                } else {
                    showToast(`주문 실패: ${result.message}`);
                }
            } catch (error) {
                showToast(`네트워크 오류: ${error.message}`);
            }
        }

        // Quick test
        async function quickTest() {
            const btn = document.getElementById('quickTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="h-4 w-4 animate-spin"></i><span>생성 중...</span>';
            lucide.createIcons();

            let successCount = 0;

            for (let i = 0; i < 10; i++) {
                const userIds = ['user-1', 'user-2', 'user-3'];
                const randomUserId = userIds[Math.floor(Math.random() * userIds.length)];
                const randomProductCount = Math.floor(Math.random() * 3) + 1;
                const randomProducts = [];

                for (let j = 0; j < randomProductCount; j++) {
                    const randomProduct = products[Math.floor(Math.random() * products.length)];
                    randomProducts.push({
                        productId: randomProduct.id,
                        quantity: Math.floor(Math.random() * 3) + 1,
                        price: randomProduct.price
                    });
                }

                const totalAmount = randomProducts.reduce((sum, p) => sum + (p.price * p.quantity), 0);

                const orderData = {
                    userId: randomUserId,
                    totalAmount: totalAmount,
                    status: ['pending', 'processing', 'completed'][Math.floor(Math.random() * 3)],
                    items: randomProducts
                };

                try {
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    if (response.ok) successCount++;
                } catch (error) {
                    console.error('Failed to create order:', error);
                }

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            showToast(`${successCount}/10개의 테스트 주문이 생성되었습니다!`);
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="zap" class="h-4 w-4"></i><span>10개 주문 생성</span>';
            lucide.createIcons();
        }

        // Modal controls
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
